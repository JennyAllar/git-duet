#!/usr/bin/env ruby
require 'fileutils'

def git_duet_install_hook_main
  prog = File.basename($0)
  Dir.chdir(`git rev-parse --show-toplevel`.chomp) do
    dest = File.join(Dir.pwd, '.git', 'hooks', 'pre-commit')
    if File.exist?(dest)
      STDERR.puts "#{prog}: A pre-commit hook already exists at #{dest}!"
      STDERR.puts "#{prog}: Move it out of the way first, mkay?"
      return 1
    end
    File.open(dest, 'w') do |f|
      f.puts '#!/bin/bash'
      f.puts 'exec < /dev/tty'
      f.puts 'exec git duet-pre-commit'
    end
    FileUtils.chmod(0755, dest)
    STDOUT.puts "#{prog}: Installed hook to #{dest}"
  end
  return 0
end

if $0 == __FILE__
  exit git_duet_install_hook_main
end
